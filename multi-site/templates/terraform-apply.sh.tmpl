#!/bin/bash
# RackN Copyright 2019
# Apply Terraform Templates

set -e

{{template "setup.tmpl" .}}

echo "=== INIT $(terraform version) ===="

terraform init -no-color

{{ if .ParamExists "rs-debug-enable" }}
{{ if eq (.Param "rs-debug-enable") true }}

echo "=== PLAN (DEBUG) TERRAFORM ===="

terraform plan -no-color

{{ end }}
{{ end }}

echo "=== RUN {{ .Param "terraform/plan-action" }} TERRAFORM ===="

terraform {{ .Param "terraform/plan-action" }} -no-color -auto-approve

out=$(terraform output --json)
echo "capturing terraform output: $out"
ip=$(jq '.machine_ip.value' <<< ${out})
if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
	echo "Detected IP from TF, Updateing Machine IP to $ip"
	drpcli machines update $RS_UUID "{\"Address\":\"$ip\"}"
else
	echo "No IP address (machine_ip.value) detected in terraform output"
fi
# capture all the output vars in the parms
echo "uploading other keys from terraform output"
for key in $(jq -r 'keys[]' <<< ${out}); do
	echo "adding $key to machine"
	drpcli machines set $RS_UUID param "TF_VAR/$key" to "$(jq -r ".$key.value" <<< ${out})"
done

echo "=== DONE ===="
