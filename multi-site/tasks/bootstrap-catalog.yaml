---
Description: "Setup the Manager's Local Catalog"
Name: "bootstrap-catalog"
ExtraClaims:
  - scope: "*"
    action: "*"
    specific: "*"
Templates:
  - Contents: |-
      #!/bin/bash
      # RackN Copyright 2019

      set -e
      {{template "setup.tmpl" .}}

      if drpcli plugin_providers exists "manager" 2>/dev/null >/dev/null ; then
        echo "Manager Plugin already installed, skipping"
      else
        echo "Installing Manager Plugin"
        drpcli catalog item install manager --version=tip >/dev/null
      fi


      echo "Setting up empty local manager catalog to update."
      drpcli plugins runaction manager buildCatalog

      catalog_sum=$(drpcli files exists static-catalog.zip 2>/dev/null || true)
      if [[ "$catalog_sum" != "" ]]; then
        echo "Using already present static-catalog.zip. Move it in place..."
        drpcli files download static-catalog.zip > /root/static-catalog.zip
      else
        if [[ ! -f /root/static-catalog.zip ]] ; then
          echo "Retrieving the starting static catalog"
          curl --compressed -o /root/static-catalog.zip https://rackn-private.s3-us-west-2.amazonaws.com/static-catalog.zip
        fi
      fi

      catalog_sum=$(drpcli files exists rebar-catalog/static-catalog.zip 2>/dev/null || true)
      if [[ "$catalog_sum" == "" ]]; then
        echo "Uploading the static-catalog.zip file"
        drpcli files upload /root/static-catalog.zip as "rebar-catalog/static-catalog.zip" --explode
      else
        echo "catalog already uploaded, skipping...($catalog_sum)"
      fi

      catalog_file_sum=$(drpcli files exists static-catalog.json 2>/dev/null || true)
      if [[ -f /root/rackn-catalog.json ]] ; then
        echo "Update the local catalog from root provided catalog.json"
        drpcli catalog updateLocal -c /root/rackn-catalog.json
      elif [[ "$catalog_file_sum" != "" ]] ; then
        drpcli files download static-catalog.json > static-catalog.json
        drpcli catalog updateLocal -c static-catalog.json
      else
        echo "Update the local catalog from the RackN default catalog"
        drpcli catalog updateLocal
      fi

      echo "Setting up local manager catalog"
      drpcli plugins runaction manager buildCatalog

    Name: "catalog-setup"
Meta:
  icon: "spy"
  color: "purple"
  title: "Digital Rebar Community Content"
  feature-flags: "sane-exit-codes"
