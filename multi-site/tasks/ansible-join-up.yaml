---
Name: "ansible-join-up"
Description: "Join DRP via Ansible"
Documentation: |
  Runs an embedded Ansible Playbook to run the DRP join-up process.
  Sets the Machine Workflow to Discovery

  Uses `reboot-workflow` Param.

  Expects to be in an `ansible` context.
  Expects to have `rsa-key-create` run before stage is called

  Information can be chained together by having the playbook
  write `[Machine.Uuid].json` as a file.  This will be saved on the
  machine as `Param.ansible/output`.  The entire Machine JSON is passed into
  the playbook as the `digitalrebar` variable so it is available.
RequiredParams:
  - rsa/key-public
  - rsa/key-user
  - rsa/key-private
  - reboot-workflow
Templates:
  - Contents: |-
      #!/bin/bash
      # RackN Copyright 2020

      set -e

      {{template "setup.tmpl" .}}

      # we need a keypair for Ansible
      echo "Retrieving SSH key from Machine Params rsa/key-*"
      tee rsa-{{.Machine.Name}} >/dev/null << EOF
      {{.Param "rsa/key-private" | replace "|" "\n" }}
      EOF
      chmod 600 rsa-{{.Machine.Name}}
      tee rsa-{{.Machine.Name}}.pub >/dev/null << EOF
      {{.Param "rsa/key-public"}}
      EOF
      chmod 644 rsa-{{.Machine.Name}}.pub

      export ANSIBLE_HOST_KEY_CHECKING=False

      ## Build Playbook
      echo "Building from Join-Up Playbook"
      tee join-up.yaml >/dev/null << EOF
      ---
      ### Run Join-Up via Ansible
      - hosts: all
        remote_user: "{{ .Param "rsa/key-user" }}"
        connection: "ssh"
        gather_facts: false

        tasks:

          - name: create uuid file
            copy:
              content: "{{.Machine.Uuid}}"
              dest: /etc/rs-uuid

          - name: download join-up script
            get_url:
              url: "{{.ProvisionerURL}}/machines/join-up.sh"
              dest: "./join-up.sh"
              mode: 0755

          - name: run join-up script
            shell: "nohup ./join-up.sh >/dev/null 2>&1 &"
      EOF

      echo "Run Join-Up Playbook using $(ansible-playbook --version)"
      ansible-playbook \
        -i $ADDRESS, \
        --private-key=rsa-{{ .Machine.Name }} \
        join-up.yaml

      #echo clear the workflow so join-up can continue
      drpcli machines workflow $RS_UUID {{ .Param "reboot-workflow" }}
      
      echo "Done"
    Name: "Run Playbooks"
Meta:
  icon: "cog"
  color: "blue"
  title: "Digital Rebar Community Content"
  feature-flags: "sane-exit-codes"
